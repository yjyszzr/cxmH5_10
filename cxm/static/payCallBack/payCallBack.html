<!DOCTYPE html>
<html>

<head>
    <title>微信安全支付</title>
    <meta id="viewport" name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1; user-scalable=no;" />
    <meta name="format-detection" content="telephone=no" />
    <style>
        .page {
            background: #fff !important;
        }

        .loading_wrap img {
            width: 20%;
            display: block;
            margin: 120px auto 0;
        }

        .loading_wrap p {
            font-size: 18px;
            text-align: center;
        }
    </style>
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
</head>

<body>
    <div class="page-group">
        <div class="page page-current">
            <!-- 你的html代码 -->
            <div class="loading_wrap">
                <!-- <span class="loading animate"></span> -->
                <img src="./cxzLoad.gif" alt="">
                <p>支付查询中...</p>
            </div>
        </div>
    </div>
</body>
<script type='text/javascript' src='//g.alicdn.com/sj/lib/zepto/zepto.min.js' charset='utf-8'></script>
<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm.min.js' charset='utf-8'></script>
<script>
    $.init()
</script>
<script type="text/javascript">
    var num = 1
    var time = setInterval(function () {
        num++
        var obj = {}
        obj.body = {
            'payLogId': location.href.split('?')[1].split('=')[1].replace('#','')
        }
        obj.device = {
            plat: 'h5',
            apiv: 1,
            appv: '1.0.0',
            appid: '',
            mac: '',
            w: window.screen.availWidth,
            h: window.screen.availHeight,
            os: '',
            mid: '',
            brand: '',
            build: '',
            channel: '',
            net: '',
            token: ''
        }
        $.ajax({
            type: 'post',
            url: 'http://39.106.18.39:8765/api/payment/payment/query',
            contentType:'application/json;charset=UTF-8',
            data: JSON.stringify(obj),
            beforeSend: function (request) {
                request.setRequestHeader("token",
                    localStorage.getItem('token')
                );
            },
            dataType: "json",
            success: function (data) {
                //console.log(data)
                if (data.code == '0') {
                    $.alert('充值成功',function(){
                        window.history.go(-3)
                    });
                    clearInterval(time)
                } else if(data.code >=30000&&data.code <310000) {
                    if(data.code == '304035'){
                        $.alert('如果您已经确认支付并扣款，可能存在延迟到账情况，请到账户明细中查看或联系客服查询','支付失败',function(){
                            window.history.go(-3)
                        });
                    }else if(data.code== '304036'){
                        if (num > 7) {
                            $.alert('暂未查询到您的支付结果，如果您已经确认支付并扣款，可能存在延迟到账的情况，请到账户明细中查看或联系客服查询','查询失败',function(){
                                window.history.go(-3)
                            });
                            clearInterval(time)
                        }
                    }
                }
                //console.log(data)
            }
        })
    }, 3000)

    // function doCallback() {
    //     window.history.go(-2)
    // }
    pushHistory();
    window.addEventListener("popstate", function (e) {
        window.history.go(-2)
        //alert("我监听到了浏览器的返回按钮事件啦"); //根据自己的需求实现自己的功能 
    }, false);

    function pushHistory() {
        var state = {
            title: "title",
            url: "#"
        };
        window.history.pushState(state, "title", "#");
    }
</script>
</html>